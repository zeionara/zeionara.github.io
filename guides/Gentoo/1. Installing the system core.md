# Installing the system core

::: tip The official Gentoo Handbook
The following guide has been written using the official [Gentoo Handbook][handbook]. It is strongly recommended to refer to the [handbook][handbook] in case of any situation, not covered by the guide, or for adapting the guide to your specific preferences.
:::

To start installing `Gentoo` alongside `Ghost Spectre`, boot from the bootable media by repeatedly pressing `F2` (at least on lenovo laptops) when turning on your `PC`, BIOS settings should open - configure `USB` as a boot device with higher priority than `Windows Bootloader`, press `F10` to reboot. Then in `ventoy` boot menu choose `Gentoo Installation` medium - after a few minutes command line should open with a prompt.

::: tip Opening a new shell
To open a new shell from the installer, press `ALT + F2`. To switch back, to the previous shell, press `ALT + F1`. Other `F` keys should also work the same way.
:::


Suppose we want to run a remote installation, meaning that we want to connect via `ssh` to the target device and control installation from there. Then, first of all, we should connect the target device to the Internet.

::: tabs

== Ethernet

If you are using `Ethernet` cable, no additional configuration is required in most cases, as minimal installation CD supports most hardware by default.

== Wi-Fi

When you need to connect to the Internet via `wifi`, you can use `nmtui` tool, which has an intuitive interface - just choose your network from the list and type password.

:::

To make sure you are connected to the Internet, run the following command, which should print your external IP address:

```sh
curl ifconfig.me
```

## Enabling remote installation

To enable remote installation, set root password (I recommend using something simple, like just `root` - this will be reset on reboot):

```sh
passwd root
```

Create a new user and create their `home` directory, which might be useful even on this stage, then set password:

```sh
useradd -m -G users,wheel zeio
passwd zeio
```

Change default editor to `vim` if you are more comfortable with `vim` than with `nano`:

```sh
export EDITOR=vim
```

Then add the new user to the `sudoers` list. For that run the following command:

```sh
visudo
```

A file will be open for editing, add a new line near line with `root` user configuration:

```sh
zeio ALL=(ALL) NOPASSWD: ALL
```

Then check your ip address in the local network for being able to connect to the target device by `ssh`:

```sh
ifconfig | grep 192 | cut -d ' ' -f10
```

Finally, start `ssh` service:

```sh
rc-service sshd start
```

Now `ssh` connections to the target device should be supported.

## Preparing the disks

::: tip The Official Gentoo Handbook
For more details see [the corresponding section](https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Disks) of the official Gentoo Handbook.
:::

First, list all installed drives and partitions:

```sh
lsblk
```

The command outputs something like:

```sh{3}
NAME       MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
loop0        7:0    0   687M  1 loop /run/rootfsbase
sda          8:0    0 894.3G  0 disk
├─sda1       8:1    0   200M  0 part
├─sda2       8:2    0    16M  0 part
├─sda3       8:3    0 127.3G  0 part
└─sda4       8:4    0   735M  0 part
sdb          8:16   1  14.5G  0 disk
├─sdb1       8:17   1  14.4G  0 part
│ ├─ventoy 253:0    0 779.9M  1 dm   /run/initramfs/live
│ └─sdb1   253:1    0  14.4G  0 dm
└─sdb2       8:18   1    32M  0 part
sr0         11:0    1  1024M  0 rom
```

The highlighted line here indicates the disk we will be working with, this disk has a lot of unallocated space, so we can create a new partition here, which will be used for our linux installation. Use `fdisk` tool for working with the disk:

```sh
sudo fdisk /dev/sda
```

Use `p` key to display current partition layout.

::: danger Wiping existing data
To wipe all existing data on the disk, either press `g` which will instantly overwrite current partition layout with a new GPT disklabel, or press `d` to remove partitions one by one to keep existing disklabel. These actions lead to data loss and have to be made with caution.
:::

To create a new partition, type `n`, leave `partition number` default (`5` in my case), first sector - default value (`268877824` in my case) and default value for the last sector (`1875384319` in my case). Press `p` again to check that everything is correct, and `w` to write changes. If I run `lsblk` now, I get the following output (the new partition is highlighted):

```sh{8}
NAME       MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
loop0        7:0    0   687M  1 loop /run/rootfsbase
sda          8:0    0 894.3G  0 disk
├─sda1       8:1    0   200M  0 part
├─sda2       8:2    0    16M  0 part
├─sda3       8:3    0 127.3G  0 part
├─sda4       8:4    0   735M  0 part
└─sda5       8:5    0   766G  0 part
sdb          8:16   1  14.5G  0 disk
├─sdb1       8:17   1  14.4G  0 part
│ ├─ventoy 253:0    0 779.9M  1 dm   /run/initramfs/live
│ └─sdb1   253:1    0  14.4G  0 dm
└─sdb2       8:18   1    32M  0 part
sr0         11:0    1  1024M  0 rom
```

Create filesystem on the newly created partition:

```sh
sudo mkfs.ext4 /dev/sda5
```

Now we need to mount the newly created partition:

```sh
sudo mount /dev/sda5 /mnt/gentoo
```

## Preparing Gentoo installation files

Change the root directory permissions:

```sh
sudo chown zeio:zeio /mnt/gentoo
```

Move to the mounted partition:

```sh
cd /mnt/gentoo
```

Here we need to download the `stage file`. For choosing the appropriate file, use the built-in browser:

```sh
links https://www.gentoo.org/downloads/mirrors/
```

Select `Downloads`, then navigate to `amd64 Stage 3 openrc` - download the `.tar.xz` file. Press `q` to exit `links` after the file is downloaded, then run the following command to unzip the downloaded content:

```sh
sudo tar xpvf stage3-*.tar.xz --xattrs-include='*.*' --numeric-owner -C /mnt/gentoo
```

### Configuring compile options

Open `make.conf` using the following command:

```sh
sudo vim /mnt/gentoo/etc/portage/make.conf
```

Change the file like this (to determine the value for `-j` flag in `MAKEOPTS`, run `nproc` command, set `-l` slightly above this value):

```sh
# These settings were set by the catalyst build script that automatically
# built this stage.
# Please consult /usr/share/portage/config/make.conf.example for a more
# detailed example.
COMMON_FLAGS="-O2 -pipe" # [!code --]
COMMON_FLAGS="-march=native -O2 -pipe" # [!code ++]
CFLAGS="${COMMON_FLAGS}"
CXXFLAGS="${COMMON_FLAGS}"
FCFLAGS="${COMMON_FLAGS}"
FFLAGS="${COMMON_FLAGS}"

RUSTFLAGS="${RUSTFLAGS} -C target-cpu=native"  # [!code ++]
MAKEOPTS="-j4 -l5" # [!code ++]

# NOTE: This stage was built with the bindist USE flag enabled

# This sets the language of build output to English.
# Please keep this setting intact when reporting bugs.
LC_MESSAGES=C.UTF-8
```

## Installing the base system

Copy DNS information:

```sh
sudo cp --dereference /etc/resolv.conf /mnt/gentoo/etc
```

Then chroot to the new system:

```sh
sudo arch-chroot /mnt/gentoo && source /etc/profile && export PS1="(chroot) ${PS1}"
```

Mount `efi` partition (in my case - `/dev/sda1`):

```sh
mkdir /efi
mount /dev/sda1 /efi
```

Then fetch the latest snapshot of `emerge` package registry:

```sh
emerge-webrsync
```

Select mirrors by using a special tool:

```sh
emerge --ask --verbose --oneshot app-portage/mirrorselect
mirrorselect -i -o >> /etc/portage/make.conf
```

I usually choose these mirrors:

```sh{20-26}
# These settings were set by the catalyst build script that automatically
# built this stage.
# Please consult /usr/share/portage/config/make.conf.example for a more
# detailed example.
COMMON_FLAGS="-march=native -O2 -pipe"
CFLAGS="${COMMON_FLAGS}"
CXXFLAGS="${COMMON_FLAGS}"
FCFLAGS="${COMMON_FLAGS}"
FFLAGS="${COMMON_FLAGS}"

RUSTFLAGS="${RUSTFLAGS} -C target-cpu=native"
MAKEOPTS="-j4 -l5"

# NOTE: This stage was built with the bindist USE flag enabled

# This sets the language of build output to English.
# Please keep this setting intact when reporting bugs.
LC_MESSAGES=C.UTF-8

GENTOO_MIRRORS="http://mirror.mephi.ru/gentoo-distfiles/ \
    ftp://mirror.mephi.ru/gentoo-distfiles/ \
    rsync://mirror.mephi.ru/gentoo-distfiles/ \
    https://mirror.yandex.ru/gentoo-distfiles/ \
    http://mirror.yandex.ru/gentoo-distfiles/ \
    ftp://mirror.yandex.ru/gentoo-distfiles/"
```

Then update `emerge` repositories:

```sh
emerge --sync
```

Set up `cpu flags`. You need to install a special package:

```sh
emerge --ask --oneshot app-portage/cpuid2cpuflags
```

Examine the output:

```sh
cpuid2cpuflags
```

Then copy the output to `package.use`:

```sh
echo "*/* $(cpuid2cpuflags)" > /etc/portage/package.use/00cpu-flags
```

Configure video card options:

::: tabs

=== Nvidia GPU

```sh
echo '*/* VIDEO_CARDS: nvidia' > /etc/portage/package.use/00video_cards
```

=== AMD GPU

```sh
echo '*/* VIDEO_CARDS: amdgpu radeonsi' > /etc/portage/package.use/00video_cards
```

:::

For being able to edit files manually under `chroot` and further, after rebooting into the configured system, now is the right time to install `vim` editor:

```sh
emerge --ask app-editors/vim
```

While `vim` is being installed, configure global `USE` flags in the `make.conf`:

::: tabs

=== Nvidia GPU

```sh
# These settings were set by the catalyst build script that automatically
# built this stage.
# Please consult /usr/share/portage/config/make.conf.example for a more
# detailed example.

USE="-gtk -gnome dist-kernel dbus alsa wayland bluetooth elogind opengl nvenc lua v4l screencast" # [!code ++]

COMMON_FLAGS="-march=native -O2 -pipe"
CFLAGS="${COMMON_FLAGS}"
CXXFLAGS="${COMMON_FLAGS}"
FCFLAGS="${COMMON_FLAGS}"
FFLAGS="${COMMON_FLAGS}"

RUSTFLAGS="${RUSTFLAGS} -C target-cpu=native"
MAKEOPTS="-j4 -l5"

# NOTE: This stage was built with the bindist USE flag enabled

# This sets the language of build output to English.
# Please keep this setting intact when reporting bugs.
LC_MESSAGES=C.UTF-8

GENTOO_MIRRORS="http://mirror.mephi.ru/gentoo-distfiles/ \
    ftp://mirror.mephi.ru/gentoo-distfiles/ \
    rsync://mirror.mephi.ru/gentoo-distfiles/ \
    https://mirror.yandex.ru/gentoo-distfiles/ \
    http://mirror.yandex.ru/gentoo-distfiles/ \
    ftp://mirror.yandex.ru/gentoo-distfiles/"
```

=== AMD GPU

```sh
# These settings were set by the catalyst build script that automatically
# built this stage.
# Please consult /usr/share/portage/config/make.conf.example for a more
# detailed example.

USE="-gtk -gnome dist-kernel dbus alsa wayland bluetooth elogind opengl lua v4l screencast" # [!code ++]

COMMON_FLAGS="-march=native -O2 -pipe"
CFLAGS="${COMMON_FLAGS}"
CXXFLAGS="${COMMON_FLAGS}"
FCFLAGS="${COMMON_FLAGS}"
FFLAGS="${COMMON_FLAGS}"

RUSTFLAGS="${RUSTFLAGS} -C target-cpu=native"
MAKEOPTS="-j4 -l5"

# NOTE: This stage was built with the bindist USE flag enabled

# This sets the language of build output to English.
# Please keep this setting intact when reporting bugs.
LC_MESSAGES=C.UTF-8

GENTOO_MIRRORS="http://mirror.mephi.ru/gentoo-distfiles/ \
    ftp://mirror.mephi.ru/gentoo-distfiles/ \
    rsync://mirror.mephi.ru/gentoo-distfiles/ \
    https://mirror.yandex.ru/gentoo-distfiles/ \
    http://mirror.yandex.ru/gentoo-distfiles/ \
    ftp://mirror.yandex.ru/gentoo-distfiles/"
```

:::

After changing `USE` flags update the `@world` set:

```sh
emerge --ask --verbose --update --deep --changed-use @world
```

Unmerge unnecessary packages:

```sh
emerge --ask --depclean
```

### Configuring timezone

Run the following timezone to configure `UTC+3` as your timezone:

```sh
ln -sf ../usr/share/zoneinfo/Europe/Moscow /etc/localtime
```

### Configuring locale

Uncomment required locales in the file `/etc/locale.gen`:

```sh
# en_US.UTF-8       UTF-8  # American English (United States)
en_US.UTF-8       UTF-8  # American English (United States) [!code ++]
# ru_RU.UTF-8       UTF-8  # Russian (Russia)
ru_RU.UTF-8       UTF-8  # Russian (Russia) [!code ++]
```

Then generate selected locales:

```sh
locale-gen
```

Reload the environment:

```sh
env-update && source /etc/profile && export PS1="(chroot) ${PS1}"
```

## Configuring the Linux kernel

Enable `grub` and `dracut` flags for `installkernel` module:

```sh
echo 'sys-kernel/installkernel grub dracut' > /etc/portage/package.use/installkernel
```

Install `linux-firmware`. First, allow the required license:

```sh
mkdir /etc/portage/package.license
echo 'sys-kernel/linux-firmware linux-fw-redistributable' > /etc/portage/package.license/linux-firmware
```

[handbook]: https://wiki.gentoo.org/wiki/Handbook:AMD64
